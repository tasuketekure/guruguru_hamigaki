<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ぐるぐる通知登録</title>
</head>
<body>
  <h1>ぐるぐる通知登録</h1>
  <button id="subscribeButton">通知を登録する</button>
  <p id="status"></p>

  <script>
    const publicVapidKey = 'BL_8Pfu-CE-123456...（本物のキーに置換）';
    const pushServerURL = "https://guru-push-server.onrender.com";

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => {
          document.getElementById('subscribeButton').onclick = async () => {
            const subscription = await reg.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(publicVapidKey),
            });

            const res = await fetch(`${pushServerURL}/subscribe`, {
              method: "POST",
              body: JSON.stringify(subscription),
              headers: { "Content-Type": "application/json" }
            });

            if (res.ok) {
              document.getElementById("status").textContent = "登録しました！";
            } else {
              document.getElementById("status").textContent = "登録に失敗しました。";
            }
          };
        });
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }
  </script>
</body>
</html>