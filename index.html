<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ぐるぐる通知登録</title>
</head>
<body>
  <h1>ぐるぐる通知登録ページ</h1>
  <button id="subscribe">登録する</button>
  <p id="status"></p>
  <script>
    const publicVapidKey = "BJRocsl8q13nNcMlvWZSuUcwRWpE9cUSbbMEva1M53HCD9-4FzjVWcIXYh0z0TqNo27qUphvYFpph8L-W66y0sY";

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        const registration = await navigator.serviceWorker.register('/sw.js');
        document.getElementById('subscribe').addEventListener('click', async () => {
          const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
          });

          const res = await fetch('https://guru-push-server.onrender.com/subscribe', {
            method: 'POST',
            body: JSON.stringify(subscription),
            headers: {
              'Content-Type': 'application/json'
            }
          });

          if (res.ok) {
            document.getElementById('status').textContent = '登録しました！';
          } else {
            document.getElementById('status').textContent = '登録できませんでした';
          }
        });
      });
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');

      const rawData = atob(base64);
      return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }
  </script>
</body>
</html>
